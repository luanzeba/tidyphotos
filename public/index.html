<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TidyPhotos</title>
    <link rel="stylesheet" href="/styles/main.css">

    <script>
        console.log('üîß TidyPhotos: Script loading...');
        document.addEventListener('alpine:init', () => {
            console.log('üèîÔ∏è Alpine.js: Initialized');
        });
        window.addEventListener('load', () => {
            console.log('üåç TidyPhotos: Page loaded, Alpine available:', !!window.Alpine);
        });
    </script>

    <!-- Load main app first -->
    <script type="module" src="/js/dist/tidyphotos-app.js"></script>

    <!-- Load Alpine.js after -->
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
</head>
<body>
    <div x-data="photoApp()" x-init="init()" class="app">
        <!-- Header -->
        <header class="header">
            <div class="header-left">
                <h1>TidyPhotos</h1>
                <nav class="nav-tabs">
                    <button
                        @click="setCurrentView('photos')"
                        :class="{ active: currentView === 'photos' }"
                        class="nav-tab">
                        Photos
                    </button>
                    <button
                        @click="setCurrentView('people')"
                        :class="{ active: currentView === 'people' }"
                        class="nav-tab">
                        People
                    </button>
                </nav>
            </div>
            <div class="controls" x-show="currentView === 'photos'">
                <div class="thumbnail-size-control">
                    <label for="thumbnail-size">Size:</label>
                    <input
                        type="range"
                        id="thumbnail-size"
                        min="120"
                        max="400"
                        step="20"
                        x-model="thumbnailSize"
                        @input="updateThumbnailSize($event.target.value)"
                        class="thumbnail-size-slider">
                    <span x-text="thumbnailSize + 'px'" class="thumbnail-size-value"></span>
                </div>
                <input type="search" x-model="searchQuery" placeholder="Search photos..." class="search">
            </div>
        </header>

        <div class="main-layout">
            <!-- Photos View -->
            <div x-show="currentView === 'photos'" class="photos-view">
                <!-- Left Sidebar Timeline -->
                <aside class="timeline-sidebar">
                <div class="timeline-section">
                    <h3>Years</h3>
                    <div class="timeline-buttons">
                        <template x-for="year in years" :key="year">
                            <button 
                                @click="selectYear(year)" 
                                :class="{ active: selectedYear === year }"
                                x-text="year"
                                class="timeline-btn">
                            </button>
                        </template>
                    </div>
                </div>
                
                <div class="timeline-section" x-show="selectedYear">
                    <h3>Months</h3>
                    <div class="timeline-buttons">
                        <template x-for="month in months" :key="month.number">
                            <button 
                                @click="selectMonth(month.number)" 
                                :class="{ active: selectedMonth === month.number }"
                                x-text="month.name"
                                class="timeline-btn">
                            </button>
                        </template>
                    </div>
                </div>

                <div class="timeline-section" x-show="selectedYear || selectedMonth">
                    <button @click="clearFilters()" class="clear-filters">
                        Clear Filters
                    </button>
                </div>
            </aside>

            <!-- Photo Grid -->
            <main class="photo-grid" @keydown.window="handleKeyboard">
            <template x-for="photo in filteredPhotos" :key="photo.id">
                <div 
                    class="photo-item" 
                    :class="{ selected: photo.id === selectedPhotoId }"
                    @click="selectPhoto(photo.id)"
                    @dblclick="openFullScreen(photo.id)"
                    @focus="selectPhoto(photo.id)"
                    tabindex="0">
                    <img :src="photo.thumbnail" :alt="photo.name" loading="lazy">
                    <button class="favorite-heart" :class="{ active: photo.favorite }" @click.stop="toggleFavorite(photo.id)" tabindex="-1">
                        <svg viewBox="0 0 24 24" width="16" height="16" fill="currentColor">
                            <path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/>
                        </svg>
                    </button>
                </div>
            </template>
            
            <!-- Loading State -->
            <div x-show="loading" class="loading">
                Loading photos...
            </div>
        </main>
        
        <!-- Mobile Bottom Timeline Slider -->
        <div class="mobile-timeline-slider">
            <button 
                @click="setMobileView('years')" 
                :class="{ active: mobileTimelineView === 'years' }"
                class="mobile-timeline-btn">
                Years
            </button>
            <button 
                @click="setMobileView('months')" 
                :class="{ active: mobileTimelineView === 'months' }"
                class="mobile-timeline-btn">
                Months
            </button>
            <button 
                @click="setMobileView('all')" 
                :class="{ active: mobileTimelineView === 'all' }"
                class="mobile-timeline-btn">
                All
            </button>
        </div>
            </div>

            <!-- People View -->
            <div x-show="currentView === 'people'" class="people-view">
                <!-- People Management Section -->
                <main class="people-main">
                    <div class="people-header">
                        <h2>People</h2>
                        <button @click="showAddPersonModal = true" class="add-person-btn">
                            <svg viewBox="0 0 24 24" width="16" height="16" fill="currentColor">
                                <path d="M12 2C13.1 2 14 2.9 14 4C14 5.1 13.1 6 12 6C10.9 6 10 5.1 10 4C10 2.9 10.9 2 12 2ZM21 9V7L19 7V9L17 9V11L19 11V13L21 13V11L23 11V9M16 4C16 6.21 14.21 8 12 8C9.79 8 8 6.21 8 4C8 1.79 9.79 0 12 0C14.21 0 16 1.79 16 4ZM4 7V10H1V12H4V15H6V12H9V10H6V7H4Z"/>
                            </svg>
                            Add Person
                        </button>
                    </div>

                    <!-- People List -->
                    <div class="people-grid">
                        <template x-for="person in people" :key="person.id">
                            <div class="person-card">
                                <div class="person-avatar">
                                    <span x-text="person.name.charAt(0).toUpperCase()"></span>
                                </div>
                                <div class="person-info">
                                    <h3 x-text="person.name"></h3>
                                    <span x-text="`${person.photoCount || 0} photos`"></span>
                                </div>
                                <div class="person-actions">
                                    <button @click="editPerson(person)" class="icon-btn" title="Edit">
                                        <svg viewBox="0 0 24 24" width="16" height="16" fill="currentColor">
                                            <path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/>
                                        </svg>
                                    </button>
                                    <button @click="deletePerson(person)" class="icon-btn delete-btn" title="Delete">
                                        <svg viewBox="0 0 24 24" width="16" height="16" fill="currentColor">
                                            <path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/>
                                        </svg>
                                    </button>
                                </div>
                            </div>
                        </template>

                        <!-- Empty State -->
                        <div x-show="people.length === 0" class="empty-state">
                            <div class="empty-icon">
                                <svg viewBox="0 0 24 24" width="48" height="48" fill="currentColor">
                                    <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
                                </svg>
                            </div>
                            <h3>No people added yet</h3>
                            <p>Add people to organize photos by faces</p>
                            <button @click="showAddPersonModal = true" class="add-person-empty-btn">
                                Add Your First Person
                            </button>
                        </div>
                    </div>
                </main>
            </div>
        </div>

        <!-- Full-Screen Photo Viewer -->
        <div x-show="fullScreenMode" class="photo-viewer-overlay" @keydown.window="handleFullScreenKeyboard">
            <div class="photo-viewer-header">
                <div class="photo-viewer-info">
                    <h3 x-text="currentPhoto?.name"></h3>
                    <span x-text="`${currentPhotoIndex + 1} of ${filteredPhotos.length}`"></span>
                </div>
                <div class="photo-viewer-controls">
                    <button
                        @click="toggleTaggingMode"
                        class="tag-btn"
                        :class="{ active: taggingMode }"
                        title="Tag Faces (T)">
                        <svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor">
                            <path d="M12 2C13.1 2 14 2.9 14 4C14 5.1 13.1 6 12 6C10.9 6 10 5.1 10 4C10 2.9 10.9 2 12 2ZM21 9V7L19 7V9L17 9V11L19 11V13L21 13V11L23 11V9M16 4C16 6.21 14.21 8 12 8C9.79 8 8 6.21 8 4C8 1.79 9.79 0 12 0C14.21 0 16 1.79 16 4Z"/>
                        </svg>
                    </button>
                    <button
                        @click="toggleFullScreenFavorite"
                        class="favorite-heart-fullscreen"
                        :class="{ active: currentPhoto?.favorite }"
                        title="Favorite (F)">
                        <svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor">
                            <path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/>
                        </svg>
                    </button>
                    <button @click="closeFullScreen" class="close-btn" title="Close (Esc or Q)">
                        ‚úï
                    </button>
                </div>
            </div>
            
            <div class="photo-viewer-content">
                <button 
                    @click="previousPhoto" 
                    class="nav-btn nav-btn-left"
                    :class="{ disabled: currentPhotoIndex === 0 }"
                    title="Previous (Left Arrow)">
                    <svg viewBox="0 0 24 24" width="16" height="16" fill="currentColor">
                        <path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"/>
                    </svg>
                </button>
                
                <div class="photo-viewer-main">
                    <div
                        class="photo-container"
                        :class="{ 'tagging-mode': taggingMode }"
                        style="position: relative; display: inline-block;"
                        @mousedown="startDrawingTag($event)"
                        @mousemove="updateDrawingTag($event)"
                        @mouseup="finishDrawingTag($event)">
                        <img
                            :src="currentPhoto ? `/api/photos/${encodeURIComponent(currentPhoto.name)}` : ''"
                            :alt="currentPhoto?.name"
                            class="full-screen-photo"
                            @click.stop
                            :draggable="false"
                            style="max-width: 100%; max-height: 80vh; display: block; user-select: none;">

                        <!-- Face tag overlays -->
                        <template x-for="tag in faceTags" :key="tag.id">
                            <div
                                class="face-tag-overlay"
                                :style="`position: absolute; left: ${tag.x}%; top: ${tag.y}%; width: ${tag.width}%; height: ${tag.height}%; border: 2px solid #007AFF; background: rgba(0, 122, 255, 0.2); z-index: 10;`">
                                <div class="face-tag-controls" style="position: absolute; top: -30px; left: 0; display: flex; gap: 5px;">
                                    <button
                                        @click.stop="openTagAssignModal(tag.id)"
                                        class="tag-assign-btn"
                                        :title="tag.personName || 'Assign Person'"
                                        style="background: #007AFF; color: white; border: none; padding: 2px 6px; border-radius: 3px; font-size: 12px;">
                                        <span x-text="tag.personName || '+'"></span>
                                    </button>
                                    <button
                                        @click.stop="removeTag(tag.id)"
                                        class="tag-remove-btn"
                                        title="Remove Tag"
                                        style="background: #FF3B30; color: white; border: none; padding: 2px 6px; border-radius: 3px; font-size: 12px;">
                                        ‚úï
                                    </button>
                                </div>
                            </div>
                        </template>

                        <!-- Drawing preview rectangle -->
                        <div x-show="isDrawingTag && drawingPreview"
                             class="drawing-preview"
                             :style="`position: absolute; left: ${drawingPreview?.x || 0}%; top: ${drawingPreview?.y || 0}%; width: ${drawingPreview?.width || 0}%; height: ${drawingPreview?.height || 0}%; border: 2px dashed #FF9500; background: rgba(255, 149, 0, 0.2); z-index: 15; pointer-events: none;`">
                        </div>

                        <!-- First click indicator for click-click mode -->
                        <div x-show="isDrawingTag && (!drawingPreview || (drawingPreview?.width === 0 && drawingPreview?.height === 0))"
                             class="first-click-indicator"
                             :style="`position: absolute; left: calc(${drawingPreview?.x || 0}% - 4px); top: calc(${drawingPreview?.y || 0}% - 4px); width: 8px; height: 8px; background: #FF9500; border: 2px solid white; border-radius: 50%; z-index: 16; pointer-events: none;`">
                        </div>

                        <!-- Tagging instructions -->
                        <div x-show="taggingMode && faceTags.length === 0" class="tagging-instructions"
                             style="position: absolute; top: 20px; left: 20px; background: rgba(0, 0, 0, 0.7); color: white; padding: 10px; border-radius: 5px; z-index: 20;">
                            <p style="margin: 0; font-size: 14px;">Draw a box around a face:</p>
                            <p style="margin: 5px 0 0 0; font-size: 12px; opacity: 0.8;">Click one corner, then click the opposite corner</p>
                            <p style="margin: 5px 0 0 0; font-size: 12px; opacity: 0.6;">Press 'T' to exit tagging mode</p>
                        </div>

                        <!-- Save button when tags exist -->
                        <div x-show="taggingMode && faceTags.length > 0" class="tagging-save"
                             style="position: absolute; bottom: 20px; right: 20px; z-index: 20;">
                            <button @click.stop="saveFaceTags()" class="save-tags-btn"
                                    style="background: #34C759; color: white; border: none; padding: 10px 20px; border-radius: 5px; font-weight: bold;">
                                Save Tags
                            </button>
                        </div>
                    </div>
                </div>
                
                <button 
                    @click="nextPhoto" 
                    class="nav-btn nav-btn-right"
                    :class="{ disabled: currentPhotoIndex === filteredPhotos.length - 1 }"
                    title="Next (Right Arrow)">
                    <svg viewBox="0 0 24 24" width="16" height="16" fill="currentColor">
                        <path d="M8.59 16.59L10 18l6-6-6-6-1.41 1.41L13.17 12z"/>
                    </svg>
                </button>
            </div>

        </div>

        <!-- Add/Edit Person Modal -->
        <div x-show="showAddPersonModal || showEditPersonModal" class="modal-overlay" @click.self="closePersonModal()">
            <div class="modal">
                <div class="modal-header">
                    <h3 x-text="showAddPersonModal ? 'Add Person' : 'Edit Person'"></h3>
                    <button @click="closePersonModal()" class="close-btn">‚úï</button>
                </div>
                <div class="modal-body">
                    <form @submit.prevent="showAddPersonModal ? addPerson() : updatePerson()">
                        <div class="form-group">
                            <label for="person-name">Name</label>
                            <input
                                type="text"
                                id="person-name"
                                x-model="personForm.name"
                                placeholder="Enter person's name"
                                required>
                        </div>
                        <div class="form-actions">
                            <button type="button" @click="closePersonModal()" class="btn-secondary">
                                Cancel
                            </button>
                            <button type="submit" class="btn-primary">
                                <span x-text="showAddPersonModal ? 'Add Person' : 'Update Person'"></span>
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Tag Assignment Modal -->
        <div x-show="showTagAssignModal" class="modal-overlay" @click.self="closeTagAssignModal()">
            <div class="modal">
                <div class="modal-header">
                    <h3>Assign Person to Face Tag</h3>
                    <button @click="closeTagAssignModal()" class="close-btn">‚úï</button>
                </div>
                <div class="modal-body">
                    <div class="person-list" style="max-height: 300px; overflow-y: auto;">
                        <template x-for="person in people" :key="person.id">
                            <button
                                @click="assignPersonToTag(person.id, person.name)"
                                class="person-assign-btn"
                                style="display: block; width: 100%; text-align: left; padding: 10px; margin-bottom: 5px; border: 1px solid #ddd; border-radius: 5px; background: white; color: #333; cursor: pointer; transition: background-color 0.2s;"
                                @mouseover="$el.style.backgroundColor = '#f0f0f0'"
                                @mouseout="$el.style.backgroundColor = 'white'"
                                x-text="person.name">
                            </button>
                        </template>

                        <div x-show="people.length === 0" style="text-align: center; padding: 20px; color: #666;">
                            <p>No people available. Add people first in the People tab.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</body>
</html>
